<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>KidzGoal Tracker</title>

  <!-- Mobile friendly scaling -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      font-size: 16px;
      background: #f9f9f9;
      color: #333;
    }

    header {
      background: #4CAF50;
      color: white;
      padding: 16px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }

    .controls {
      background: #fff;
      padding: 12px;
      border-bottom: 1px solid #ddd;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: center;
    }

    select, input, button {
      padding: 6px 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    button {
      background: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { background: #45a049; }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
    }
    th { background: #eee; }
    .done { background-color: #c8f7c5; }
    .notdone { background-color: #f7c5c5; }

    @media (max-width: 600px) {
      header { font-size: 18px; }
      .controls { flex-direction: column; }
      select, input, button { width: 100%; }
    }
  </style>
</head>
<body>
  <header>KidzGoal Tracker</header>

  <div class="controls">
    <label>Track by:
      <select id="trackMode" onchange="updateSelectors(); renderTable()">
        <option value="day" selected>Day</option>
        <option value="week">Week</option>
        <option value="month">Month</option>
        <option value="year">Year</option>
      </select>
    </label>

    <label>How many:
      <input type="number" id="rangeLength" value="7" min="1" max="365" onchange="renderTable()">
    </label>

    <label>Sort:
      <select id="sortMode" onchange="renderTable()">
        <option value="none">None</option>
        <option value="day">Day</option>
        <option value="week">Week</option>
        <option value="month">Month</option>
        <option value="year">Year</option>
      </select>
    </label>

    <label>Year:
      <input list="yearOptions" id="yearSelect" onchange="renderTable()">
      <datalist id="yearOptions"></datalist>
    </label>

    <label>Month:
      <select id="monthSelect" onchange="renderTable()">
        <option value="01">January</option>
        <option value="02">February</option>
        <option value="03">March</option>
        <option value="04">April</option>
        <option value="05">May</option>
        <option value="06">June</option>
        <option value="07">July</option>
        <option value="08">August</option>
        <option value="09">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
      </select>
    </label>

    <label>Person:
      <select id="personFilter" onchange="renderTable()">
        <option value="">All</option>
      </select>
    </label>

    <input type="text" id="newGoalInput" placeholder="Enter a goal">
    <input type="text" id="personInput" placeholder="Person">
    <button onclick="addGoal()">Add Goal</button>
  </div>

  <div id="trackerTable"></div>
  <div id="summaryStats"></div>

  <script>
    let goals = JSON.parse(localStorage.getItem("goals") || "[]");
    let progress = JSON.parse(localStorage.getItem("progress") || "{}");

    const yearSelect = document.getElementById("yearSelect");
    const yearOptions = document.getElementById("yearOptions");
    const currentYear = new Date().getFullYear();
    for (let y = 2000; y <= currentYear; y++) {
      const opt = document.createElement("option");
      opt.value = y;
      yearOptions.appendChild(opt);
    }
    yearSelect.value = currentYear;

    function updateSelectors() {
      const mode = document.getElementById("trackMode").value;
      const monthSel = document.getElementById("monthSelect");
      monthSel.style.display = (mode === "year") ? "none" : "inline";
      saveData();
    }

    function saveData() {
      localStorage.setItem("goals", JSON.stringify(goals));
      localStorage.setItem("progress", JSON.stringify(progress));
    }

    function addGoal() {
      const name = document.getElementById("newGoalInput").value.trim();
      const person = document.getElementById("personInput").value.trim();
      if (name && person) {
        goals.push({ name, person });
        document.getElementById("newGoalInput").value = "";
        document.getElementById("personInput").value = "";
        saveData();
        renderTable();
      }
    }

    function deleteGoal(index) {
      for (let key in progress) {
        if (progress[key][index]) progress[key].splice(index, 1);
      }
      goals.splice(index, 1);
      saveData();
      renderTable();
    }

    function toggleStatus(goalIndex, unitKey) {
      const trackMode = document.getElementById("trackMode").value;
      const month = document.getElementById("monthSelect").value;
      const year = document.getElementById("yearSelect").value;
      const key = trackMode === "year" ? `year-${unitKey}` : `${trackMode}-${year}-${month}`;
      if (!progress[key]) progress[key] = [];
      if (!progress[key][goalIndex]) progress[key][goalIndex] = {};
      const current = progress[key][goalIndex][unitKey];
      progress[key][goalIndex][unitKey] = current === "‚úî" ? "‚úò" : current === "‚úò" ? "" : "‚úî";
      saveData();
      renderTable();
    }

    function getGoalPercent(index, mode, year, month) {
      let count = 0, total = 0;
      for (let key in progress) {
        if (!progress[key][index]) continue;
        if (!key.startsWith(mode)) continue;
        if (!key.includes(year)) continue;
        if (mode !== "year" && !key.includes(month)) continue;
        const entry = progress[key][index];
        for (let d in entry) {
          if (entry[d] === "‚úî") count++;
          total++;
        }
      }
      return total ? { percent: Math.round((count / total) * 100), count, total } : { percent: 0, count: 0, total: 0 };
    }

    function renderTable() {
      const trackMode = document.getElementById("trackMode").value;
      const sortMode = document.getElementById("sortMode").value;
      const viewPerson = document.getElementById("personFilter").value;
      const month = document.getElementById("monthSelect").value;
      const year = document.getElementById("yearSelect").value;
      const range = parseInt(document.getElementById("rangeLength").value);
      const tableDiv = document.getElementById("trackerTable");

      const uniquePeople = [...new Set(goals.map(g => g.person))];
      const filter = document.getElementById("personFilter");
      filter.innerHTML = '<option value="">All</option>' + uniquePeople.map(p => `<option value="${p}">${p}</option>`).join('');
      filter.value = viewPerson;

      let goalList = goals.map((g, i) => ({ ...g, index: i }));
      if (viewPerson) goalList = goalList.filter(g => g.person === viewPerson);
      if (sortMode !== "none") {
        goalList.sort((a, b) => getGoalPercent(b.index, sortMode, year, month).percent - getGoalPercent(a.index, sortMode, year, month).percent);
      }

      let html = `<table><thead><tr><th>Goal</th>`;
      let unitKeys = [];

      if (trackMode === "day") {
        const days = new Date(year, parseInt(month), 0).getDate();
        for (let d = 1; d <= Math.min(range, days); d++) {
          html += `<th>${d}</th>`;
          unitKeys.push(d);
        }
      } else if (trackMode === "week") {
        for (let w = 1; w <= Math.min(range, 6); w++) {
          html += `<th>W${w}</th>`;
          unitKeys.push(`W${w}`);
        }
      } else if (trackMode === "month") {
        for (let m = 1; m <= Math.min(range, 12); m++) {
          html += `<th>${m.toString().padStart(2, '0')}</th>`;
          unitKeys.push(m.toString().padStart(2, '0'));
        }
      } else if (trackMode === "year") {
        for (let y = 0; y < range; y++) {
          const yr = parseInt(year) + y;
          html += `<th>${yr}</th>`;
          unitKeys.push(yr);
        }
      }

      html += `<th>Progress</th><th>Delete</th></tr></thead><tbody>`;

      goalList.forEach((g) => {
        html += `<tr><td>${g.name} <small>(${g.person})</small></td>`;
        unitKeys.forEach(k => {
          const key = trackMode === "year" ? `year-${k}` : `${trackMode}-${year}-${month}`;
          const val = (progress[key] && progress[key][g.index] && progress[key][g.index][k]) || "";
          const className = val === "‚úî" ? "done" : val === "‚úò" ? "notdone" : "";
          html += `<td class="${className}" onclick="toggleStatus(${g.index}, '${k}')">${val}</td>`;
        });
        const { count, total, percent } = getGoalPercent(g.index, sortMode === "none" ? trackMode : sortMode, year, month);
        html += `<td>${count} / ${total} (${percent}%)</td>`;
        html += `<td><button onclick="deleteGoal(${g.index})">üóëÔ∏è</button></td></tr>`;
      });

      html += "</tbody></table>";
      tableDiv.innerHTML = html;
    }

    updateSelectors();
    renderTable();
  </script>
</body>
</html>
