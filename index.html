<!DOCTYPE html>
<html>
<head>
  <title>Goal Tracker</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table, td, th { border: 1px solid black; border-collapse: collapse; }
    th, td { padding: 5px; text-align: center; }
    .done { background-color: #c8f7c5; }
    .notdone { background-color: #f7c5c5; }
    select, input, button { margin: 5px; }
  </style>
</head>
<body>
  <h1>Goal Tracker</h1>

  <label for="trackMode">Track by:</label>
  <select id="trackMode" onchange="updateSelectors(); renderTable()">
    <option value="day" selected>Day</option>
    <option value="week">Week</option>
    <option value="month">Month</option>
    <option value="year">Year</option>
  </select>

  <label for="rangeLength">How many to track:</label>
  <input type="number" id="rangeLength" value="7" min="1" max="365" onchange="renderTable()">

  <label for="sortMode">Sort by:</label>
  <select id="sortMode" onchange="renderTable()">
    <option value="none">None</option>
    <option value="day">Day</option>
    <option value="week">Week</option>
    <option value="month">Month</option>
    <option value="year">Year</option>
  </select>

  <label for="yearSelect">Start Year:</label>
  <input list="yearOptions" id="yearSelect" onchange="renderTable()">
  <datalist id="yearOptions"></datalist>

  <label for="monthSelect">Start Month:</label>
  <select id="monthSelect" onchange="renderTable()">
    <option value="01">January</option>
    <option value="02">February</option>
    <option value="03">March</option>
    <option value="04">April</option>
    <option value="05">May</option>
    <option value="06">June</option>
    <option value="07">July</option>
    <option value="08">August</option>
    <option value="09">September</option>
    <option value="10">October</option>
    <option value="11">November</option>
    <option value="12">December</option>
  </select>

  <label for="personFilter">Filter by Person:</label>
  <select id="personFilter" onchange="renderTable()">
    <option value="">All</option>
  </select>

  <input type="text" id="newGoalInput" placeholder="Enter a goal">
  <input type="text" id="personInput" placeholder="Person">
  <button onclick="addGoal()">Add Goal</button>

  <div id="trackerTable"></div>
  <div id="summaryStats"></div>

  <script>
    let goals = JSON.parse(localStorage.getItem("goals") || "[]");
    let progress = JSON.parse(localStorage.getItem("progress") || "{}");

    const yearSelect = document.getElementById("yearSelect");
    const yearOptions = document.getElementById("yearOptions");
    const currentYear = new Date().getFullYear();
    for (let y = 2000; y <= currentYear; y++) {
      const opt = document.createElement("option");
      opt.value = y;
      yearOptions.appendChild(opt);
    }
    yearSelect.value = currentYear;

    function updateSelectors() {
      const mode = document.getElementById("trackMode").value;
      const monthSel = document.getElementById("monthSelect");
      monthSel.style.display = (mode === "year") ? "none" : "inline";
      saveData();
    }

    function saveData() {
      localStorage.setItem("goals", JSON.stringify(goals));
      localStorage.setItem("progress", JSON.stringify(progress));
    }

    function addGoal() {
      const name = document.getElementById("newGoalInput").value.trim();
      const person = document.getElementById("personInput").value.trim();
      if (name && person) {
        goals.push({ name, person });
        document.getElementById("newGoalInput").value = "";
        document.getElementById("personInput").value = "";
        saveData();
        renderTable();
      }
    }

    function deleteGoal(index) {
      for (let key in progress) {
        if (progress[key][index]) progress[key].splice(index, 1);
      }
      goals.splice(index, 1);
      saveData();
      renderTable();
    }

    function toggleStatus(goalIndex, unitKey) {
      const trackMode = document.getElementById("trackMode").value;
      const month = document.getElementById("monthSelect").value;
      const year = document.getElementById("yearSelect").value;
      const key = trackMode === "year" ? `year-${unitKey}` : `${trackMode}-${year}-${month}`;
      if (!progress[key]) progress[key] = [];
      if (!progress[key][goalIndex]) progress[key][goalIndex] = {};
      const current = progress[key][goalIndex][unitKey];
      progress[key][goalIndex][unitKey] = current === "‚úî" ? "‚úò" : current === "‚úò" ? "" : "‚úî";
      saveData();
      renderTable();
    }

    function getGoalPercent(index, mode, year, month) {
      let count = 0, total = 0;
      for (let key in progress) {
        if (!progress[key][index]) continue;
        if (!key.startsWith(mode)) continue;
        if (!key.includes(year)) continue;
        if (mode !== "year" && !key.includes(month)) continue;
        const entry = progress[key][index];
        for (let d in entry) {
          if (entry[d] === "‚úî") count++;
          total++;
        }
      }
      return total ? { percent: Math.round((count / total) * 100), count, total } : { percent: 0, count: 0, total: 0 };
    }

    function renderTable() {
      const trackMode = document.getElementById("trackMode").value;
      const sortMode = document.getElementById("sortMode").value;
      const viewPerson = document.getElementById("personFilter").value;
      const month = document.getElementById("monthSelect").value;
      const year = document.getElementById("yearSelect").value;
      const range = parseInt(document.getElementById("rangeLength").value);
      const tableDiv = document.getElementById("trackerTable");

      const uniquePeople = [...new Set(goals.map(g => g.person))];
      const filter = document.getElementById("personFilter");
      filter.innerHTML = '<option value="">All</option>' + uniquePeople.map(p => `<option value="${p}">${p}</option>`).join('');
      filter.value = viewPerson;

      let goalList = goals.map((g, i) => ({ ...g, index: i }));
      if (viewPerson) goalList = goalList.filter(g => g.person === viewPerson);
      if (sortMode !== "none") {
        goalList.sort((a, b) => getGoalPercent(b.index, sortMode, year, month).percent - getGoalPercent(a.index, sortMode, year, month).percent);
      }

      let html = `<table><thead><tr><th>Goal</th>`;
      let unitKeys = [];

      if (trackMode === "day") {
        const days = new Date(year, parseInt(month), 0).getDate();
        for (let d = 1; d <= Math.min(range, days); d++) {
          html += `<th>${d}</th>`;
          unitKeys.push(d);
        }
      } else if (trackMode === "week") {
        for (let w = 1; w <= Math.min(range, 6); w++) {
          html += `<th>W${w}</th>`;
          unitKeys.push(`W${w}`);
        }
      } else if (trackMode === "month") {
        for (let m = 1; m <= Math.min(range, 12); m++) {
          html += `<th>${m.toString().padStart(2, '0')}</th>`;
          unitKeys.push(m.toString().padStart(2, '0'));
        }
      } else if (trackMode === "year") {
        for (let y = 0; y < range; y++) {
          const yr = parseInt(year) + y;
          html += `<th>${yr}</th>`;
          unitKeys.push(yr);
        }
      }

      html += `<th>Progress</th><th>Delete</th></tr></thead><tbody>`;

      goalList.forEach((g, rank) => {
        html += `<tr><td>${g.name} <small>(${g.person})</small></td>`;
        unitKeys.forEach(k => {
          const key = trackMode === "year" ? `year-${k}` : `${trackMode}-${year}-${month}`;
          const val = (progress[key] && progress[key][g.index] && progress[key][g.index][k]) || "";
          const className = val === "‚úî" ? "done" : val === "‚úò" ? "notdone" : "";
          html += `<td class="${className}" onclick="toggleStatus(${g.index}, '${k}')">${val}</td>`;
        });
        const { count, total, percent } = getGoalPercent(g.index, sortMode === "none" ? trackMode : sortMode, year, month);
        html += `<td>${count} / ${total} (${percent}%)</td>`;
        html += `<td><button onclick="deleteGoal(${g.index})">üóëÔ∏è</button></td></tr>`;
      });

      html += "</tbody></table>";
      tableDiv.innerHTML = html;
    }

    updateSelectors();
    renderTable();
  </script>
</body>
</html>
